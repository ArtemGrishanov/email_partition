<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Email ‚Üí AB –≥—Ä—É–ø–ø–∞ (1‚Äì100)</title>
  <style>
    :root { --bg:#0b1020; --card:#111833; --text:#e8ecff; --muted:#94a3b8; --accent:#4f46e5; --ok:#10b981; --warn:#f59e0b; --err:#ef4444; }
    *{box-sizing:border-box}
    body{margin:0; font-family:Inter,ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial,"Noto Sans","Apple Color Emoji","Segoe UI Emoji"; background:radial-gradient(1000px 600px at 10% -10%, #1b2347, #0b1020) fixed; color:var(--text)}
    .wrap{max-width:880px; margin:40px auto; padding:0 16px}
    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:16px; padding:22px; box-shadow:0 8px 32px rgba(0,0,0,.25)}
    h1{font-size:24px; margin:0 0 16px}
    p{color:var(--muted); margin:0 0 18px}
    label{display:block; font-size:12px; color:var(--muted); margin-bottom:6px}
    input, textarea{width:100%; padding:12px 14px; border-radius:12px; border:1px solid rgba(255,255,255,.12); background:#0f1530; color:var(--text); outline:none; font:inherit; resize:vertical; min-height:48px}
    input:focus, textarea:focus{border-color:var(--accent); box-shadow:0 0 0 3px rgba(79,70,229,.25)}
    .grid{display:grid; grid-template-columns:1fr; gap:14px}
    @media (min-width:720px){ .grid{grid-template-columns:1.2fr 1fr} }
    .row{display:grid; grid-template-columns:1fr 1fr; gap:14px}
    .muted{font-size:12px; color:var(--muted)}
    .out{margin-top:14px; display:flex; align-items:center; gap:10px}
    .badge{display:inline-flex; align-items:center; gap:8px; padding:8px 12px; border-radius:999px; border:1px solid rgba(255,255,255,.14); background:#0d1330}
    .num{font-weight:700; font-size:20px}
    .isIn{font-weight:600}
    .good{color:var(--ok)}
    .bad{color:#f43f5e}
    .copy{margin-left:auto; background:transparent; border:1px solid rgba(255,255,255,.18); color:var(--text); padding:8px 12px; border-radius:10px; cursor:pointer}
    .copy:hover{border-color:var(--accent)}
    .btn{margin-top:8px; background:var(--accent); color:#fff; border:none; border-radius:12px; padding:12px 18px; font-weight:600; cursor:pointer; transition:background .2s ease}
    .btn:hover{background:#4338ca}
    .btn:disabled{opacity:.6; cursor:not-allowed}
    .footer{margin-top:18px; font-size:12px; color:var(--muted)}
    code{background:#0f1530; padding:2px 6px; border-radius:6px; border:1px solid rgba(255,255,255,.10)}
    .stack{display:flex; flex-direction:column; gap:10px}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <h1>üíå Email ‚Üí AB –≥—Ä—É–ø–ø–∞ (1‚Äì100)</h1>
      <p>–î–µ—Ç–µ—Ä–º–∏–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ —Ö—ç—à–∏—Ä—É–µ–º e‚Äëmail –≤ —á–∏—Å–ª–æ <strong>1‚Äì100</strong>. –£–∫–∞–∂–∏—Ç–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –≥—Ä—É–ø–ø (–Ω–∞–ø—Ä–∏–º–µ—Ä <code>1-20,50-100</code>) ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ–∫–∞–∂–µ—Ç, –≤—Ö–æ–¥–∏—Ç –ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç. –ï—Å—Ç—å –ø–æ–ª–µ ¬´–∫–ª—é—á —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞¬ª, —á—Ç–æ–±—ã –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Ç–µ—Å—Ç–æ–≤ –∏–º–µ—Ç—å —Ä–∞–∑–Ω—ã–µ —Ä–∞–∑–±–∏–µ–Ω–∏—è.</p>
      <div class="grid">
        <div>
          <label for="email">Email</label>
          <input id="email" placeholder="example@gmail.com" autocomplete="off" />
        </div>
        <div class="row">
          <div>
            <label for="ranges">–î–∏–∞–ø–∞–∑–æ–Ω—ã –≥—Ä—É–ø–ø</label>
            <input id="ranges" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 1-20,50-100" />
          </div>
          <div>
            <label for="key">–ö–ª—é—á —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
            <input id="key" placeholder="release_42" />
          </div>
        </div>
      </div>
      <div class="out">
        <div class="badge"><span>–ì—Ä—É–ø–ø–∞:</span> <span id="bucket" class="num">‚Äî</span></div>
        <div class="badge"><span>–í —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–µ:</span> <span id="inexp" class="isIn">‚Äî</span></div>
        <button id="copy" class="copy" title="–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é bucket(email,key)">–ö–æ–ø–∏—è —Ñ—É–Ω–∫—Ü–∏–∏</button>
      </div>
      <div class="footer">–ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è: <code>trim ‚Üí lowerCase</code>. –•—ç—à: <code>SHA‚Äë256</code> (Web Crypto), —Ä–µ–∑–µ—Ä–≤ ‚Äî <code>FNV‚Äë1a</code>. –ú–∞–ø–ø–∏–Ω–≥: <code>(hash % 100) + 1</code>.</div>
    </div>
    <div class="card">
      <h2>–§–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞ –∞–¥—Ä–µ—Å–æ–≤</h2>
      <p class="muted">–í—Å—Ç–∞–≤—å—Ç–µ –Ω–∞–±–æ—Ä e‚Äëmail –∞–¥—Ä–µ—Å–æ–≤ (–ø–æ –æ–¥–Ω–æ–º—É –≤ —Å—Ç—Ä–æ–∫–µ) ‚Äî –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –ø–æ—Å—á–∏—Ç–∞–µ—Ç –æ–±—â–µ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∏ –æ—Å—Ç–∞–≤–∏—Ç —Ç–æ–ª—å–∫–æ —Ç–µ, —á—Ç–æ –ø–æ–ø–∞–¥–∞—é—Ç –≤ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –≤—ã—à–µ.</p>
      <div class="stack">
        <div>
          <label for="bulk-emails">–°–ø–∏—Å–æ–∫ –∞–¥—Ä–µ—Å–æ–≤</label>
          <textarea id="bulk-emails" rows="8" placeholder="user1@example.com&#10;user2@example.com"></textarea>
          <div class="muted">–í—Å–µ–≥–æ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ: <strong id="bulk-count">0</strong></div>
        </div>
        <button id="filter-btn" class="btn">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å</button>
        <div>
          <label for="filtered-emails">–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –∞–¥—Ä–µ—Å–∞</label>
          <textarea id="filtered-emails" rows="8" readonly placeholder="–†–µ–∑—É–ª—å—Ç–∞—Ç –ø–æ—è–≤–∏—Ç—Å—è –ø–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏"></textarea>
          <div class="muted">–ü–æ—Å–ª–µ —Ñ–∏–ª—å—Ç—Ä–∞: <strong id="filtered-count">0</strong></div>
        </div>
        <button id="corp-btn" class="btn">–§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∞–¥—Ä–µ—Å–∞</button>
        <div>
          <label for="corp-emails">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã–µ –∞–¥—Ä–µ—Å–∞</label>
          <textarea id="corp-emails" rows="6" readonly placeholder="–°–Ω–∞—á–∞–ª–∞ –≤—ã–ø–æ–ª–Ω–∏—Ç–µ –æ–±—ã—á–Ω—É—é —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é"></textarea>
          <div class="muted">–ö–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω—ã—Ö: <strong id="corp-count">0</strong></div>
        </div>
        <p class="muted">–ò—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è —Ç–µ –∂–µ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –∏ –∫–ª—é—á —ç–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∞, —á—Ç–æ —É–∫–∞–∑–∞–Ω—ã –≤ –ø–∞–Ω–µ–ª–∏ –≤—ã—à–µ. –ï—Å–ª–∏ –¥–∏–∞–ø–∞–∑–æ–Ω—ã –ø—É—Å—Ç—ã, —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—É–¥–µ—Ç –ø—É—Å—Ç—ã–º.</p>
      </div>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const emailEl = $("email");
    const rangesEl = $("ranges");
    const keyEl = $("key");
    const outBucket = $("bucket");
    const outIn = $("inexp");
    const bulkInput = $("bulk-emails");
    const bulkCount = $("bulk-count");
    const filteredOut = $("filtered-emails");
    const filteredCount = $("filtered-count");
    const filterBtn = $("filter-btn");
    const corpBtn = $("corp-btn");
    const corpOut = $("corp-emails");
    const corpCount = $("corp-count");

    // --- Public, copyable API ---
    async function bucket(email, key = "") {
      if (!email || typeof email !== 'string') return null;
      const norm = normalizeEmail(email);
      const msg = key ? key + "\n" + norm : norm;
      let n = await sha256ToUint32(msg).catch(() => null);
      if (n === null) n = fnv1aUint32(msg); // fallback
      return (n % 100) + 1; // 1..100
    }

    function normalizeEmail(e) {
      return String(e).trim().toLowerCase();
    }

    async function sha256ToUint32(s) {
      const enc = new TextEncoder();
      const buf = enc.encode(s);
      const digest = await crypto.subtle.digest('SHA-256', buf);
      const v = new DataView(digest);
      // Take first 4 bytes as unsigned int32
      return v.getUint32(0, false); // big-endian
    }

    function fnv1aUint32(str) {
      let hash = 0x811c9dc5;
      for (let i = 0; i < str.length; i++) {
        hash ^= str.charCodeAt(i);
        hash = (hash >>> 0) * 0x01000193 >>> 0;
      }
      return hash >>> 0;
    }

    function parseRanges(s) {
      if (!s) return [];
      return s.split(',').map(x => x.trim()).filter(Boolean).map(chunk => {
        const m = chunk.match(/^(\d{1,3})(?:\s*[-‚Äì]\s*(\d{1,3}))?$/);
        if (!m) return null;
        const a = Math.max(1, Math.min(100, parseInt(m[1],10)));
        const b = m[2] ? Math.max(1, Math.min(100, parseInt(m[2],10))) : a;
        return a <= b ? [a,b] : [b,a];
      }).filter(Boolean);
    }

    function inRanges(val, ranges) {
      for (const [a,b] of ranges) if (val >= a && val <= b) return true;
      return false;
    }

    const publicDomains = new Set([
      'gmail.com','googlemail.com','yahoo.com','yahoo.fr','yahoo.de',
      'hotmail.com','outlook.com','live.com','msn.com','icloud.com','me.com',
      'yandex.ru','yandex.ua','yandex.kz','yandex.by','ya.ru','mail.ru','inbox.ru','list.ru','bk.ru',
      'protonmail.com','pm.me','zoho.com','gmx.com','tutanota.com'
    ]);

    function isCorporateEmail(email) {
      const norm = normalizeEmail(email);
      const parts = norm.split('@');
      if (parts.length !== 2) return false;
      const domain = parts[1];
      if (!domain || !domain.includes('.')) return false;
      return !publicDomains.has(domain);
    }

    function splitEmailList(raw) {
      if (!raw) return [];
      return raw
        .replace(/[;,]+/g, '\n')
        .split(/\n+/)
        .map(e => e.trim())
        .filter(Boolean);
    }

    function updateBulkCounter() {
      const total = splitEmailList(bulkInput.value).length;
      bulkCount.textContent = total;
      return total;
    }

    async function recompute() {
      const email = emailEl.value;
      if (!email) { outBucket.textContent = '‚Äî'; outIn.textContent = '‚Äî'; outIn.className='isIn'; return; }
      const b = await bucket(email, keyEl.value || "");
      outBucket.textContent = b;
      const ranges = parseRanges(rangesEl.value);
      const ok = inRanges(b, ranges);
      outIn.textContent = ok ? '–î–ê' : '–ù–ï–¢';
      outIn.className = 'isIn ' + (ok ? 'good' : 'bad');
    }

    emailEl.addEventListener('input', recompute);
    rangesEl.addEventListener('input', recompute);
    keyEl.addEventListener('input', recompute);
    bulkInput.addEventListener('input', updateBulkCounter);

    document.addEventListener('DOMContentLoaded', () => {
      // sensible defaults
      rangesEl.value = '0-49';
      recompute();
      updateBulkCounter();
    });

    filterBtn.addEventListener('click', async () => {
      const emails = splitEmailList(bulkInput.value);
      updateBulkCounter();
      filteredOut.value = '';
      filteredCount.textContent = '0';
      corpOut.value = '';
      corpCount.textContent = '0';

      const ranges = parseRanges(rangesEl.value);
      if (!ranges.length || !emails.length) {
        return;
      }

      filterBtn.disabled = true;
      const btnOriginal = filterBtn.textContent;
      filterBtn.textContent = '–§–∏–ª—å—Ç—Ä—É—é‚Ä¶';

      try {
        const key = keyEl.value || "";
        const buckets = await Promise.all(emails.map(email => bucket(email, key)));
        const passed = [];
        buckets.forEach((b, idx) => {
          if (inRanges(b, ranges)) passed.push(emails[idx]);
        });
        filteredOut.value = passed.join('\n');
        filteredCount.textContent = passed.length;
      } finally {
        filterBtn.disabled = false;
        filterBtn.textContent = btnOriginal;
      }
    });

    corpBtn.addEventListener('click', () => {
      const emails = splitEmailList(filteredOut.value);
      corpOut.value = '';
      corpCount.textContent = '0';
      if (!emails.length) return;
      const corpEmails = emails.filter(isCorporateEmail);
      corpOut.value = corpEmails.join('\n');
      corpCount.textContent = corpEmails.length;
    });

    // Copy helper: puts a ready-to-use function on clipboard
    const copyBtn = $("copy");
    copyBtn.addEventListener('click', async () => {
      const fn = `// Deterministic AB bucket (1..100)
export async function abBucket(email, key = "") {
  const norm = String(email).trim().toLowerCase();
  const msg = key ? key + "\n" + norm : norm;
  try {
    const buf = new TextEncoder().encode(msg);
    const dig = await crypto.subtle.digest('SHA-256', buf);
    const v = new DataView(dig);
    const n = v.getUint32(0, false);
    return (n % 100) + 1;
  } catch {
    let h = 0x811c9dc5;
    for (let i = 0; i < msg.length; i++) { h ^= msg.charCodeAt(i); h = (h >>> 0) * 0x01000193 >>> 0; }
    return (h % 100) + 1;
  }
}`;
      await navigator.clipboard.writeText(fn);
      copyBtn.textContent = '–°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
      setTimeout(() => copyBtn.textContent = '–ö–æ–ø–∏—è —Ñ—É–Ω–∫—Ü–∏–∏', 1400);
    });
  </script>
</body>
</html>
